#!/bin/bash
MINECRAFTDIR="${HOME}/.minecraft"
VERSION="1.10.2"

error () {
	color_RED='\033[0;31m'
	color_NOCOLOR='\033[0m'
	printf '%b\n' "$(tput bold)${color_RED}=>$(tput sgr0) $@"
	exit 1;
}

say () {
	printf '%b\n' "$(tput bold)=>$(tput sgr0) $@"
}

PATCHFORJSON="ZGlmZiAtTmF1ciBhLzEuMTAuMi1wcGM2NC5qc29uIGIvMS4xMC4yLXBwYzY0Lmpzb24KLS0tIGEvMS4xMC4yLXBwYzY0Lmpzb24JMjAxNi0xMS0wMiAyMDoyMTowNS43MjcyNjkwMDAgLTA1MDAKKysrIGIvMS4xMC4yLXBwYzY0Lmpzb24JMjAxNi0xMS0wMiAyMDo0Mjo1Ny4yODA2MDcxMjIgLTA1MDAKQEAgLTEsNSArMSw1IEBACiB7Ci0gICJpZCI6ICIxLjEwLjIiLAorICAiaWQiOiAiMS4xMC4yLXBwYzY0IiwKICAgInRpbWUiOiAiMjAxNi0xMC0yMlQxNToyODowMy0wNTowMCIsCiAgICJyZWxlYXNlVGltZSI6ICIyMDE2LTA2LTIzVDA0OjE3OjMyLTA1OjAwIiwKICAgInR5cGUiOiAicmVsZWFzZSIsCkBAIC0zMjgsNyArMzI4LDcgQEAKICAgICAgIH0KICAgICB9LAogICAgIHsKLSAgICAgICJuYW1lIjogIm9yZy5sd2pnbC5sd2pnbDpsd2pnbC1wbGF0Zm9ybToyLjkuNC1uaWdodGx5LTIwMTUwMjA5IiwKKyAgICAgICJuYW1lIjogIm9yZy5sd2pnbC5sd2pnbDpsd2pnbC1wbGF0Zm9ybToyLjkuNC1wcGM2NCIsCiAgICAgICAicnVsZXMiOiBbCiAgICAgICAgIHsKICAgICAgICAgICAiYWN0aW9uIjogImFsbG93IgpAQCAtMzQ0LDE0NCArMzQ0LDE2IEBACiAgICAgICAgICJsaW51eCI6ICJuYXRpdmVzLWxpbnV4IiwKICAgICAgICAgIm9zeCI6ICJuYXRpdmVzLW9zeCIsCiAgICAgICAgICJ3aW5kb3dzIjogIm5hdGl2ZXMtd2luZG93cyIKLSAgICAgIH0sCi0gICAgICAiZXh0cmFjdCI6IHsKLSAgICAgICAgImV4Y2x1ZGUiOiBbCi0gICAgICAgICAgIk1FVEEtSU5GLyIKLSAgICAgICAgXQotICAgICAgfSwKLSAgICAgICJkb3dubG9hZHMiOiB7Ci0gICAgICAgICJhcnRpZmFjdCI6IHsKLSAgICAgICAgICAidXJsIjogImh0dHBzOi8vbGlicmFyaWVzLm1pbmVjcmFmdC5uZXQvb3JnL2x3amdsL2x3amdsL2x3amdsLXBsYXRmb3JtLzIuOS40LW5pZ2h0bHktMjAxNTAyMDkvbHdqZ2wtcGxhdGZvcm0tMi45LjQtbmlnaHRseS0yMDE1MDIwOS5qYXIiLAotICAgICAgICAgICJzaGExIjogImIwNGYzZWU4ZjVlNDNmYTNiMTYyOTgxYjUwYmI3MmZlMWFjYWJiMzMiLAotICAgICAgICAgICJzaXplIjogMjIKLSAgICAgICAgfSwKLSAgICAgICAgImNsYXNzaWZpZXJzIjogewotICAgICAgICAgICJuYXRpdmVzLWxpbnV4IjogewotICAgICAgICAgICAgInVybCI6ICJodHRwczovL2xpYnJhcmllcy5taW5lY3JhZnQubmV0L29yZy9sd2pnbC9sd2pnbC9sd2pnbC1wbGF0Zm9ybS8yLjkuNC1uaWdodGx5LTIwMTUwMjA5L2x3amdsLXBsYXRmb3JtLTIuOS40LW5pZ2h0bHktMjAxNTAyMDktbmF0aXZlcy1saW51eC5qYXIiLAotICAgICAgICAgICAgInNoYTEiOiAiOTMxMDc0ZjQ2Yzc5NWQyZjdiMzBlZDYzOTVkZjU3MTVjZmQ3Njc1YiIsCi0gICAgICAgICAgICAic2l6ZSI6IDU3ODY4MAotICAgICAgICAgIH0sCi0gICAgICAgICAgIm5hdGl2ZXMtb3N4IjogewotICAgICAgICAgICAgInVybCI6ICJodHRwczovL2xpYnJhcmllcy5taW5lY3JhZnQubmV0L29yZy9sd2pnbC9sd2pnbC9sd2pnbC1wbGF0Zm9ybS8yLjkuNC1uaWdodGx5LTIwMTUwMjA5L2x3amdsLXBsYXRmb3JtLTIuOS40LW5pZ2h0bHktMjAxNTAyMDktbmF0aXZlcy1vc3guamFyIiwKLSAgICAgICAgICAgICJzaGExIjogImJjYWI4NTBmOGY0ODdjM2Y0YzRkYmFiZGU3NzhiYjgyYmQxYTQwZWQiLAotICAgICAgICAgICAgInNpemUiOiA0MjY4MjIKLSAgICAgICAgICB9LAotICAgICAgICAgICJuYXRpdmVzLXdpbmRvd3MiOiB7Ci0gICAgICAgICAgICAidXJsIjogImh0dHBzOi8vbGlicmFyaWVzLm1pbmVjcmFmdC5uZXQvb3JnL2x3amdsL2x3amdsL2x3amdsLXBsYXRmb3JtLzIuOS40LW5pZ2h0bHktMjAxNTAyMDkvbHdqZ2wtcGxhdGZvcm0tMi45LjQtbmlnaHRseS0yMDE1MDIwOS1uYXRpdmVzLXdpbmRvd3MuamFyIiwKLSAgICAgICAgICAgICJzaGExIjogImI4NGQ1MTAyYjlkYmZhYmZlYjVlNDNjN2UyODI4ZDk4YTdmYzgwZTAiLAotICAgICAgICAgICAgInNpemUiOiA2MTM3NDgKLSAgICAgICAgICB9Ci0gICAgICAgIH0KLSAgICAgIH0KLSAgICB9LAotICAgIHsKLSAgICAgICJuYW1lIjogIm9yZy5sd2pnbC5sd2pnbDpsd2pnbDoyLjkuMi1uaWdodGx5LTIwMTQwODIyIiwKLSAgICAgICJydWxlcyI6IFsKLSAgICAgICAgewotICAgICAgICAgICJhY3Rpb24iOiAiYWxsb3ciLAotICAgICAgICAgICJvcyI6IHsKLSAgICAgICAgICAgICJuYW1lIjogIm9zeCIKLSAgICAgICAgICB9Ci0gICAgICAgIH0KLSAgICAgIF0sCi0gICAgICAiZG93bmxvYWRzIjogewotICAgICAgICAiYXJ0aWZhY3QiOiB7Ci0gICAgICAgICAgInVybCI6ICJodHRwczovL2xpYnJhcmllcy5taW5lY3JhZnQubmV0L29yZy9sd2pnbC9sd2pnbC9sd2pnbC8yLjkuMi1uaWdodGx5LTIwMTQwODIyL2x3amdsLTIuOS4yLW5pZ2h0bHktMjAxNDA4MjIuamFyIiwKLSAgICAgICAgICAic2hhMSI6ICI3NzA3MjA0YzlmZmE1ZDkxNjYyZGU5NWYwYTIyNGUyZjcyMWIyMmFmIiwKLSAgICAgICAgICAic2l6ZSI6IDEwNDU2MzIKLSAgICAgICAgfQotICAgICAgfQotICAgIH0sCi0gICAgewotICAgICAgIm5hbWUiOiAib3JnLmx3amdsLmx3amdsOmx3amdsX3V0aWw6Mi45LjItbmlnaHRseS0yMDE0MDgyMiIsCi0gICAgICAicnVsZXMiOiBbCi0gICAgICAgIHsKLSAgICAgICAgICAiYWN0aW9uIjogImFsbG93IiwKLSAgICAgICAgICAib3MiOiB7Ci0gICAgICAgICAgICAibmFtZSI6ICJvc3giCi0gICAgICAgICAgfQotICAgICAgICB9Ci0gICAgICBdLAotICAgICAgImRvd25sb2FkcyI6IHsKLSAgICAgICAgImFydGlmYWN0IjogewotICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly9saWJyYXJpZXMubWluZWNyYWZ0Lm5ldC9vcmcvbHdqZ2wvbHdqZ2wvbHdqZ2xfdXRpbC8yLjkuMi1uaWdodGx5LTIwMTQwODIyL2x3amdsX3V0aWwtMi45LjItbmlnaHRseS0yMDE0MDgyMi5qYXIiLAotICAgICAgICAgICJzaGExIjogImYwZTYxMmM4NDBhNzYzOWMxZjc3ZjY4ZDcyYTI4ZGFlMmYwYzg0OTAiLAotICAgICAgICAgICJzaXplIjogMTczODg3Ci0gICAgICAgIH0KICAgICAgIH0KICAgICB9LAogICAgIHsKLSAgICAgICJuYW1lIjogIm9yZy5sd2pnbC5sd2pnbDpsd2pnbC1wbGF0Zm9ybToyLjkuMi1uaWdodGx5LTIwMTQwODIyIiwKLSAgICAgICJydWxlcyI6IFsKLSAgICAgICAgewotICAgICAgICAgICJhY3Rpb24iOiAiYWxsb3ciLAotICAgICAgICAgICJvcyI6IHsKLSAgICAgICAgICAgICJuYW1lIjogIm9zeCIKLSAgICAgICAgICB9Ci0gICAgICAgIH0KLSAgICAgIF0sCisgICAgICAibmFtZSI6ICJuZXQuamF2YS5qaW5wdXQ6amlucHV0LXBsYXRmb3JtOjIuMC41LXBwYzY0IiwKICAgICAgICJuYXRpdmVzIjogewogICAgICAgICAibGludXgiOiAibmF0aXZlcy1saW51eCIsCiAgICAgICAgICJvc3giOiAibmF0aXZlcy1vc3giLAogICAgICAgICAid2luZG93cyI6ICJuYXRpdmVzLXdpbmRvd3MiCiAgICAgICB9LAotICAgICAgImV4dHJhY3QiOiB7Ci0gICAgICAgICJleGNsdWRlIjogWwotICAgICAgICAgICJNRVRBLUlORi8iCi0gICAgICAgIF0KLSAgICAgIH0sCi0gICAgICAiZG93bmxvYWRzIjogewotICAgICAgICAiY2xhc3NpZmllcnMiOiB7Ci0gICAgICAgICAgIm5hdGl2ZXMtbGludXgiOiB7Ci0gICAgICAgICAgICAidXJsIjogImh0dHBzOi8vbGlicmFyaWVzLm1pbmVjcmFmdC5uZXQvb3JnL2x3amdsL2x3amdsL2x3amdsLXBsYXRmb3JtLzIuOS4yLW5pZ2h0bHktMjAxNDA4MjIvbHdqZ2wtcGxhdGZvcm0tMi45LjItbmlnaHRseS0yMDE0MDgyMi1uYXRpdmVzLWxpbnV4LmphciIsCi0gICAgICAgICAgICAic2hhMSI6ICJkODk4YTMzYjVkMGE2ZWYzZmVkM2E0ZWFkNTA2NTY2ZGNlNjcyMGE1IiwKLSAgICAgICAgICAgICJzaXplIjogNTc4NTM5Ci0gICAgICAgICAgfSwKLSAgICAgICAgICAibmF0aXZlcy1vc3giOiB7Ci0gICAgICAgICAgICAidXJsIjogImh0dHBzOi8vbGlicmFyaWVzLm1pbmVjcmFmdC5uZXQvb3JnL2x3amdsL2x3amdsL2x3amdsLXBsYXRmb3JtLzIuOS4yLW5pZ2h0bHktMjAxNDA4MjIvbHdqZ2wtcGxhdGZvcm0tMi45LjItbmlnaHRseS0yMDE0MDgyMi1uYXRpdmVzLW9zeC5qYXIiLAotICAgICAgICAgICAgInNoYTEiOiAiNzlmNWNlMmZlYTAyZTc3ZmU0N2EzYzc0NTIxOTE2N2E1NDIxMjFkNyIsCi0gICAgICAgICAgICAic2l6ZSI6IDQ2ODExNgotICAgICAgICAgIH0sCi0gICAgICAgICAgIm5hdGl2ZXMtd2luZG93cyI6IHsKLSAgICAgICAgICAgICJ1cmwiOiAiaHR0cHM6Ly9saWJyYXJpZXMubWluZWNyYWZ0Lm5ldC9vcmcvbHdqZ2wvbHdqZ2wvbHdqZ2wtcGxhdGZvcm0vMi45LjItbmlnaHRseS0yMDE0MDgyMi9sd2pnbC1wbGF0Zm9ybS0yLjkuMi1uaWdodGx5LTIwMTQwODIyLW5hdGl2ZXMtd2luZG93cy5qYXIiLAotICAgICAgICAgICAgInNoYTEiOiAiNzhiMmE1NWNlNGRjMjljNmIzZWM0ZGY4Y2ExNjVlYmEwNWY5YjM0MSIsCi0gICAgICAgICAgICAic2l6ZSI6IDYxMzY4MAotICAgICAgICAgIH0KLSAgICAgICAgfQotICAgICAgfQotICAgIH0sCi0gICAgewotICAgICAgIm5hbWUiOiAibmV0LmphdmEuamlucHV0OmppbnB1dC1wbGF0Zm9ybToyLjAuNSIsCi0gICAgICAibmF0aXZlcyI6IHsKLSAgICAgICAgImxpbnV4IjogIm5hdGl2ZXMtbGludXgiLAotICAgICAgICAib3N4IjogIm5hdGl2ZXMtb3N4IiwKLSAgICAgICAgIndpbmRvd3MiOiAibmF0aXZlcy13aW5kb3dzIgotICAgICAgfSwKLSAgICAgICJleHRyYWN0IjogewotICAgICAgICAiZXhjbHVkZSI6IFsKLSAgICAgICAgICAiTUVUQS1JTkYvIgotICAgICAgICBdCi0gICAgICB9LAotICAgICAgImRvd25sb2FkcyI6IHsKLSAgICAgICAgImNsYXNzaWZpZXJzIjogewotICAgICAgICAgICJuYXRpdmVzLWxpbnV4IjogewotICAgICAgICAgICAgInVybCI6ICJodHRwczovL2xpYnJhcmllcy5taW5lY3JhZnQubmV0L25ldC9qYXZhL2ppbnB1dC9qaW5wdXQtcGxhdGZvcm0vMi4wLjUvamlucHV0LXBsYXRmb3JtLTIuMC41LW5hdGl2ZXMtbGludXguamFyIiwKLSAgICAgICAgICAgICJzaGExIjogIjdmZjgzMmE2ZWI5YWI2YTc2N2YxYWRlMmI1NDgwOTJkMGZhNjQ3OTUiLAotICAgICAgICAgICAgInNpemUiOiAxMDM2MgotICAgICAgICAgIH0sCi0gICAgICAgICAgIm5hdGl2ZXMtb3N4IjogewotICAgICAgICAgICAgInVybCI6ICJodHRwczovL2xpYnJhcmllcy5taW5lY3JhZnQubmV0L25ldC9qYXZhL2ppbnB1dC9qaW5wdXQtcGxhdGZvcm0vMi4wLjUvamlucHV0LXBsYXRmb3JtLTIuMC41LW5hdGl2ZXMtb3N4LmphciIsCi0gICAgICAgICAgICAic2hhMSI6ICI1M2Y5YzkxOWYzNGQyY2E5ZGU4YzUxZmM0ZTFlODI4MjAyOWE5MjMyIiwKLSAgICAgICAgICAgICJzaXplIjogMTIxODYKLSAgICAgICAgICB9LAotICAgICAgICAgICJuYXRpdmVzLXdpbmRvd3MiOiB7Ci0gICAgICAgICAgICAidXJsIjogImh0dHBzOi8vbGlicmFyaWVzLm1pbmVjcmFmdC5uZXQvbmV0L2phdmEvamlucHV0L2ppbnB1dC1wbGF0Zm9ybS8yLjAuNS9qaW5wdXQtcGxhdGZvcm0tMi4wLjUtbmF0aXZlcy13aW5kb3dzLmphciIsCi0gICAgICAgICAgICAic2hhMSI6ICIzODVlZTA5M2UwMWY1ODdmMzBlZTFjOGEyZWU3ZDQwOGZkNzMyZTE2IiwKLSAgICAgICAgICAgICJzaXplIjogMTU1MTc5Ci0gICAgICAgICAgfQotICAgICAgICB9Ci0gICAgICB9CisgICAgICAiY2xpZW50cmVxIjogdHJ1ZQogICAgIH0KICAgXSwKICAgIm1haW5DbGFzcyI6ICJuZXQubWluZWNyYWZ0LmNsaWVudC5tYWluLk1haW4iLApAQCAtNTA3LDQgKzM3OSw0IEBACiAgICAgInNoYTEiOiAiNzIyNDFkYjNjMGJkYzM5ZTM5YjIwMjE4MmZmMDAwMGRhNTI3MWExZCIsCiAgICAgInNpemUiOiAxNDU4NzQKICAgfQotfQpcIE5vIG5ld2xpbmUgYXQgZW5kIG9mIGZpbGUKK30K"
for var in "$@"; do
	case "$var" in
		"-m"*)	MINECRAFTDIR="${var:2}";;
		"-v"*)	VERSION="${var:2}";;
	esac
	shift
done

VERSIONSDIR="${MINECRAFTDIR}/versions"
LIBRARIESDIR="${MINECRAFTDIR}/libraries"
TMPDIR="/tmp/mcppc-${USER}"
WORKSPACE="${TMPDIR}/workspace"

TARGETVERSION="${VERSION}-ppc64"
JSON="${VERSIONSDIR}/${VERSION}/${VERSION}.json"
JAR="${VERSIONSDIR}/${VERSION}/${VERSION}.jar"
TARGETJSON="${WORKSPACE}/versions/${TARGETVERSION}/${TARGETVERSION}.json"
TARGETJAR="${WORKSPACE}/versions/${TARGETVERSION}/${TARGETVERSION}.jar"

mkdir -p ${WORKSPACE}
mkdir -p ${WORKSPACE}/versions/${TARGETVERSION}
mkdir -p ${WORKSPACE}/libraries
mkdir -p ${WORKSPACE}/libraries/org/lwjgl/lwjgl/lwjgl-platform/2.9.4-ppc64
mkdir -p ${WORKSPACE}/libraries/net/java/jinput/jinput-platform/2.0.5-ppc64

# check if we are running on ppc64
if [[ $(uname -m) != "ppc64" ]]; then
	say "This is not a powerpc."
fi

# check if MINECRAFTDIR is a vaild minecraft directory
if !([[ -d "${VERSIONSDIR}" ]] && [[ -d "${LIBRARIESDIR}/com/mojang" ]]); then
	error "${MINECRAFTDIR} does not appear to contain a minecraft installation."
fi
say "Using ${MINECRAFTDIR} as the minecraft installation."

# 
if !([[ -d "${VERSIONSDIR}/${VERSION}" ]]); then
	error "You need to start ${VERSION} with your launcher at least once."
fi
say "Generating ${TARGETVERSION} from ${VERSION}."

say "Fetching LWJGL repository."
git clone https://github.com/LWJGL/lwjgl.git ${TMPDIR}/lwjgl

say "Patching LD_PATH."
sed -e "s|<arg line=\"\${linker_flags32}\"/>|<arg line=\"\${linker_flags32} -L${JAVA_HOME}/lib/ppc64\"/>|g" \
	-e "s|<arg line=\"\${linker_flags64}\"/>|<arg line=\"\${linker_flags64} -L${JAVA_HOME}/lib/ppc64\"/>|g" \
	-i "${TMPDIR}/lwjgl/platform_build/linux_ant/build.xml"

say "Building LWJGL."
bash -c "cd ${TMPDIR}/lwjgl; ant all"
(( $? )) && error "LWJGL build failed."

say "Preparing version."
cp -v ${JAR} ${TARGETJAR}
cp -v ${JSON} ${TARGETJSON}

say "Preparing lwjgl platform jar."
bash -c "cd ${TMPDIR}/lwjgl/libs/linux; zip ${TMPDIR}/lwjgl-platform-2.9.4-ppc64-natives-linux.zip liblwjgl* libopenal*"
bash -c "cd ${TMPDIR}/lwjgl/libs/linux; zip ${TMPDIR}/jinput-platform-2.0.5-ppc64-natives-linux.zip libjinput-linux*"
cp "${TMPDIR}/lwjgl-platform-2.9.4-ppc64-natives-linux.zip" "${WORKSPACE}/libraries/org/lwjgl/lwjgl/lwjgl-platform/2.9.4-ppc64/lwjgl-platform-2.9.4-ppc64-natives-linux.jar"
cp "${TMPDIR}/jinput-platform-2.0.5-ppc64-natives-linux.zip" "${WORKSPACE}/libraries/net/java/jinput/jinput-platform/2.0.5-ppc64/jinput-platform-2.0.5-ppc64-natives-linux.jar"

say "Preparing ${TARGETVERSION} configurations."
bash -c "cd ${WORKSPACE}/versions/${TARGETVERSION}; echo -n ${PATCHFORJSON} | base64 --decode | patch -p1;"

say "Applying files."
cp -Rv ${WORKSPACE}/* ${MINECRAFTDIR}
